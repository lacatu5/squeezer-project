{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}Squeezer Scan Report - {{ target }}{% endblock %}

{% block header %}
<header>
    <h1>Squeezer Scan Report</h1>
    <div class="subtitle">{{ target }} • Scanned at {{ timestamp }}</div>
</header>
{% endblock %}

{% block content %}
<div class="grid">
    <div class="card">
        <div class="card-value critical">{{ severity.critical }}</div>
        <div class="card-title">Critical</div>
    </div>
    <div class="card">
        <div class="card-value high">{{ severity.high }}</div>
        <div class="card-title">High</div>
    </div>
    <div class="card">
        <div class="card-value medium">{{ severity.medium }}</div>
        <div class="card-title">Medium</div>
    </div>
    <div class="card">
        <div class="card-value low">{{ severity.low }}</div>
        <div class="card-title">Low</div>
    </div>
    <div class="card">
        <div class="card-value">{{ templates }}</div>
        <div class="card-title">Templates</div>
    </div>
    <div class="card">
        <div class="card-value">{{ "%.1f"|format(duration) }}s</div>
        <div class="card-title">Duration</div>
    </div>
</div>

<div class="grid">
    <div class="card">
        <div class="card-title">Severity Distribution</div>
        {{ macros.severity_chart(severity) }}
    </div>
    <div class="card">
        <div class="card-title">OWASP Top 10 2025</div>
        {{ macros.owasp_chart(owasp) }}
    </div>
</div>

<h2>Filters</h2>
<div class="filter-section">
    <div class="filter-group">
        <span class="filter-label">Severity</span>
        <div class="filter-bar">
            <button class="filter-btn active" data-filter-type="severity" data-filter="all">All</button>
            <button class="filter-btn" data-filter-type="severity" data-filter="critical">Crit ({{ severity.critical }})</button>
            <button class="filter-btn" data-filter-type="severity" data-filter="high">High ({{ severity.high }})</button>
            <button class="filter-btn" data-filter-type="severity" data-filter="medium">Med ({{ severity.medium }})</button>
            <button class="filter-btn" data-filter-type="severity" data-filter="low">Low ({{ severity.low }})</button>
        </div>
    </div>

    <div class="filter-group">
        <span class="filter-label">Type</span>
        <div class="filter-bar">
            <button class="filter-btn active" data-filter-type="scope" data-filter="all">All</button>
            <button class="filter-btn" data-filter-type="scope" data-filter="app">App ({{ app_count }})</button>
            <button class="filter-btn" data-filter-type="scope" data-filter="generic">Generic ({{ generic_count }})</button>
        </div>
    </div>

    {% if owasp_codes %}
    <div class="filter-group">
        <span class="filter-label">OWASP</span>
        <div class="filter-bar">
            <button class="filter-btn active" data-filter-type="owasp" data-filter="all">All</button>
            {% for code in owasp_codes %}
            <button class="filter-btn" data-filter-type="owasp" data-filter="{{ code }}">{{ code }}</button>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if tags %}
    <div class="filter-group">
        <span class="filter-label">Tags</span>
        <div class="filter-bar">
            <button class="filter-btn active" data-filter-type="tag" data-filter="all">All</button>
            {% for tag in tags %}
            <button class="filter-btn" data-filter-type="tag" data-filter="{{ tag }}">{{ tag }}</button>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<h2>Vulnerabilities</h2>
<div id="findings-container">
    {% if findings %}
        {% for finding in findings %}
            {{ macros.finding_card(finding) }}
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-title">No vulnerabilities found</div>
            <div class="empty-text">The scan completed successfully without detecting any security issues.</div>
        </div>
    {% endif %}
</div>

{% if errors %}
<h2>Errors</h2>
<div class="card">
    <div style="color: #ff4444; font-size: 12px;">{{ errors|join('<br>')|safe }}</div>
</div>
{% endif %}
{% endblock %}

{% block footer %}
<footer>
    Generated by Squeezer • {{ timestamp }} • {{ total_findings }} total findings ({{ unique_findings }} unique)
</footer>
{% endblock %}

{% block scripts %}
<script>
    const activeFilters = { severity: 'all', scope: 'all', owasp: 'all', tag: 'all' };

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const filterType = btn.dataset.filterType;
            const filterValue = btn.dataset.filter;

            btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            activeFilters[filterType] = filterValue;
            applyFilters();
        });
    });

    function applyFilters() {
        document.querySelectorAll('.finding-card').forEach(card => {
            const matchSeverity = activeFilters.severity === 'all' || card.dataset.severity === activeFilters.severity;
            const matchScope = activeFilters.scope === 'all' || card.dataset.scope === activeFilters.scope;
            const matchOwasp = activeFilters.owasp === 'all' || card.dataset.owasp === activeFilters.owasp;

            let matchTag = activeFilters.tag === 'all';
            if (!matchTag) {
                const cardTags = card.dataset.tags.split(',');
                matchTag = cardTags.includes(activeFilters.tag);
            }

            const visible = matchSeverity && matchScope && matchOwasp && matchTag;
            card.style.display = visible ? 'block' : 'none';
        });
    }

    function toggleRawData(header) {
        const content = header.nextElementSibling;
        const toggle = header.querySelector('.raw-data-toggle');
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            toggle.textContent = '-';
        } else {
            content.classList.add('collapsed');
            toggle.textContent = '+';
        }
    }
</script>
{% endblock %}
