id: negative-quantity
info:
  name: Negative Quantity Business Logic Flaw
  description: Detects if server accepts negative quantity values in basket items
  tags:
    - business-logic
    - input-validation

variables:
  email: "{{USER_EMAIL}}"
  password: "{{USER_PASSWORD}}"

requests:
  - name: Authenticate to get basket ID
    method: POST
    path: /rest/user/login
    headers:
      Content-Type: application/json
    body: '{"email": "{{email}}", "password": "{{password}}"}'
    extractors:
      - type: json
        name: basket_id
        selector: "$.bid"
      - type: json
        name: auth_token
        selector: "$.authentication.token"

  - name: Add item with negative quantity
    method: POST
    path: /api/BasketItems
    headers:
      Content-Type: application/json
      Authorization: "Bearer {{auth_token}}"
    body: '{"ProductId": 1, "quantity": -5, "basketId": "{{basket_id}}"}'
    matchers:
      - type: status
        values: [200, 201]
      - type: semantic
        selector: "$.data.quantity"
        condition: negative
    on_match:
      vulnerability: NEGATIVE_QUANTITY
      message: Server accepted negative quantity in basket item
      remediation: Validate that quantity is a positive integer on the server side
